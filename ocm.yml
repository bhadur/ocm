 resources:
  repositories:
  - repository: ocm
    type: github
    endpoint: bhadur
    name: bhadur/ocm
    
 pool:
  name: 'Default'  

 variables:
    WORK_DIR: $(Pipeline.Workspace)/ocm
    BUILD_DIR: $(WORK_DIR)/build
    BUILD_TYPE: OCM
    OV_VERSION: openvino_2021.2.185
    TEST_FILE: test_list.txt
    OPENVINO_BIN_DIR: /opt/intel/openvino_2021.2.185
    TESTMODE: UTEST
    DEVICE: CPU
    
 steps:

   - script: |
      rm -rf $(WORK_DIR) ; mkdir $(WORK_DIR)
      rm -rf $(BUILD_DIR) ; mkdir $(BUILD_DIR)
      
   
   - checkout: self
     clean: true
     lfs: false
     path: ocm
     
   - script: |
      pwd
      pwd
      export TF_LOCATION=/home/bhadur/setup/artifacts/tensorflow
      BUILD_TYPE=OCM
      OV_VERSION="openvino_2021.2.185"
      TEST_FILE="test_list.txt"
      TESTMODE="UTEST"
      DEVICE="CPU"
     displayName: "Setup"     
   
   - script: |
      cd $(WORK_DIR)
      echo ${BUILD_TYPE}
      echo ${OV_VERSION}
      echo ${TEST_FILE}
      echo ${DEVICE}      
      source /home/bhadur/ocm_tf_setup/env/bin/activate
      bash build_ocm.sh /home/bhadur/ocm_tf_setup/tensorflow/
      pwd
     workingDirectory: $(WORK_DIR)  
     displayName: "Build"
             
   - script: |
      cd ${WORK_DIR}/test/python
      echo $OPENVINO_BIN_DIR
      echo ${BUILD_TYPE}
      echo ${WORK_DIR}
      echo ${TESTMODE}
      echo ${TEST_FILE}
      echo ${DEVICE}
      bash run_test_setup.sh ${OPENVINO_BIN_DIR}
      bash run_test.sh ${OPENVINO_BIN_DIR} ${BUILD_TYPE} ${TESTMODE} ${TEST_FILE} ${DEVICE}
     workingDirectory: $(WORK_DIR)   
     displayName: "OCM Tests"  
     
   - script: |
      cd $(WORK_DIR)
      mkdir -p $WORK_DIR/TESTDIR/
      mkdir -p $WORK_DIR/LastLog/
      cd $WORK_DIR/test/python/
      cp -r tf_ocm_logs/ $WORK_DIR/LastLog
      cd $WORK_DIR/LastLog/
      mkdir -p $WORK_DIR/TESTDIR/$DEVICE/${OV_VERSION}/tf_ocm_logs
      cp -r $WORK_DIR/LastLog/tf_ocm_logs/$DEVICE/* $WORK_DIR/TESTDIR/$DEVICE/${OV_VERSION}/tf_ocm_logs/
      rm -rf $WORK_DIR/LastLog/ 
      cd $WORK_DIR/test/python/
      pip3 install XlsxWriter
      python3 /home/bhadur/tflow/jenkins_workspace/utilityrobot.py $WORK_DIR/TESTDIR
      cp ocm_report.xlsx /tmp
     workingDirectory: $(WORK_DIR)  
     displayName: "Logging and report"
